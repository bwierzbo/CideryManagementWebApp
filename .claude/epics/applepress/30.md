---
name: Database Migration Implementation
status: open
created: 2025-09-14T05:42:42Z
updated: 2025-09-14T05:58:51Z
github: https://github.com/bwierzbo/CideryManagementWebApp/issues/30
depends_on: [29]
parallel: false
conflicts_with: []
---

# Task: Database Migration Implementation

## Description
Create Drizzle schema files for new press_runs and press_run_loads tables, generate migration SQL files, and implement proper indexes for performance. Includes testing migration rollback scenarios to ensure safe database operations following established Drizzle ORM patterns.

## Acceptance Criteria
- [ ] New pgEnum definitions added for press run status
- [ ] `press_runs` table implemented in Drizzle schema with all required fields
- [ ] `press_run_loads` table implemented with proper foreign key relationships
- [ ] Migration SQL files generated using `pnpm db:generate`
- [ ] Performance indexes implemented for common query patterns
- [ ] Relations defined following existing patterns in schema.ts
- [ ] Migration rollback scenarios tested successfully
- [ ] Type exports added for tRPC integration
- [ ] Schema validation passes against existing database
- [ ] Migration tested against seed data without conflicts

## Technical Details

### Implementation Approach
- **Schema Extension**: Add new tables to existing `packages/db/src/schema.ts`
- **Migration Generation**: Use Drizzle Kit to generate migration SQL
- **Index Strategy**: Create indexes for vendor_id, status, created_at for mobile performance
- **Relations**: Define Drizzle relations following existing patterns
- **Type Safety**: Export TypeScript types for use in API layer

### Key Considerations
- Follow existing table definition patterns (uuid primary keys, timestamps)
- Use consistent decimal precision for weight/volume fields
- Implement proper CASCADE rules for parent-child relationships
- Test migration against existing purchase/vendor data
- Ensure rollback capability for production safety

### Files to be Modified/Created
1. **Schema Updates**:
   - `packages/db/src/schema.ts` - Add new table definitions and relations
   - Migration files in `packages/db/drizzle/` directory

2. **Index Implementation**:
   - Performance indexes for mobile app queries
   - Composite indexes for common filter patterns
   - Foreign key indexes for join performance

3. **Migration Testing**:
   - Test against existing seed data
   - Verify rollback procedures
   - Validate constraints and relationships

### Database Objects to Create
1. **Enums**:
   - `press_run_status` enum ('in_progress', 'completed', 'cancelled')

2. **Tables**:
   - `press_runs` with full audit fields and vessel relationships
   - `press_run_loads` with purchase line traceability

3. **Indexes**:
   - `press_runs_vendor_id_idx` for vendor filtering
   - `press_runs_status_idx` for status queries
   - `press_run_loads_press_run_id_idx` for load retrieval
   - Composite indexes for mobile query optimization

4. **Relations**:
   - press_runs -> vendors (many-to-one)
   - press_runs -> vessels (many-to-one, nullable)
   - press_run_loads -> press_runs (many-to-one, CASCADE)
   - press_run_loads -> purchase_items (many-to-one)
   - press_run_loads -> apple_varieties (many-to-one)

## Dependencies
- [ ] **Task 001**: Database Schema Design must be completed
- [ ] Existing Drizzle configuration and migration setup
- [ ] PostgreSQL database instance for testing
- [ ] Seed data for migration validation

## Effort Estimate
- Size: L
- Hours: 20-28 hours
- Parallel: false (depends on schema design completion)

## Definition of Done
- [ ] Drizzle schema files updated with new table definitions
- [ ] Migration SQL files generated and tested
- [ ] All indexes created with proper performance characteristics
- [ ] Relations properly defined and tested
- [ ] Migration rollback tested successfully
- [ ] TypeScript types exported for API layer integration
- [ ] `pnpm db:migrate` executes successfully
- [ ] `pnpm db:test` passes with new schema
- [ ] Documentation updated with migration notes and rollback procedures