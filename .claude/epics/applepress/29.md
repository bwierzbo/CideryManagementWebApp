---
name: Database Schema Design
status: open
created: 2025-09-14T05:42:42Z
updated: 2025-09-14T05:58:51Z
github: https://github.com/bwierzbo/CideryManagementWebApp/issues/29
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Database Schema Design

## Description
Design press_runs and press_run_loads tables for the ApplePress epic, following existing audit/RBAC patterns from the codebase. Create comprehensive schema design that extends existing domain entities rather than creating new subsystems, maintaining consistency with purchase order system patterns.

## Acceptance Criteria
- [ ] `press_runs` table designed with proper status enum constraints ('in_progress', 'completed', 'cancelled')
- [ ] `press_run_loads` table designed with foreign key relationships to vendors, purchase_lines, vessels
- [ ] Audit fields included following existing `created_at/created_by/updated_at/updated_by` pattern
- [ ] Unit handling follows canonical storage pattern (kg for weight, L for volume) with original unit tracking
- [ ] Status enum with proper CHECK constraints defined
- [ ] Performance indexes designed for common query patterns
- [ ] Foreign key constraints properly defined with ON DELETE CASCADE where appropriate
- [ ] Schema documentation includes relationship diagrams and field descriptions
- [ ] Design reviewed against existing schema patterns for consistency

## Technical Details

### Implementation Approach
- **Schema Design Pattern**: Extend existing audit/RBAC patterns from main schema
- **Status Management**: Use pgEnum for press run status with proper constraints
- **Weight/Volume Units**: Follow existing canonical storage patterns (kg/L) with original unit tracking
- **Relationships**: Foreign keys to vendors, purchase_lines (purchase_items), vessels tables
- **Audit Trail**: Include full audit fields (`created_at`, `created_by`, `updated_at`, `updated_by`)

### Key Considerations
- Maintain consistency with existing table naming conventions (snake_case)
- Use decimal precision patterns matching existing cost/weight/volume fields
- Include proper indexing strategy for mobile app performance
- Design for resumable press runs (draft state persistence)
- Support vendor-based press run organization

### Schema Components Required
1. **press_runs table**:
   - Primary key (uuid)
   - Vendor relationship
   - Status enum with constraints
   - Time tracking (start_time, end_time)
   - Juice volume and vessel assignment
   - Labor tracking fields
   - Full audit trail

2. **press_run_loads table**:
   - Primary key (uuid)
   - Press run relationship (CASCADE delete)
   - Purchase line relationship for traceability
   - Apple variety reference
   - Weight in canonical (kg) and original units
   - Full audit fields

3. **Indexes and Constraints**:
   - Performance indexes for mobile queries
   - Foreign key constraints with proper cascade rules
   - Check constraints for status enums
   - Unique constraints where applicable

## Dependencies
- [ ] Existing schema.ts file structure and patterns
- [ ] Audit schema patterns from schema/audit.ts
- [ ] Understanding of existing purchase_items and vendors tables
- [ ] Knowledge of vessel management table structure

## Effort Estimate
- Size: L
- Hours: 24-32 hours
- Parallel: true (foundational schema design work)

## Definition of Done
- [ ] Schema design document completed with table definitions
- [ ] All foreign key relationships properly mapped
- [ ] Index strategy documented for performance optimization
- [ ] Audit and RBAC patterns correctly applied
- [ ] Schema validates against existing codebase patterns
- [ ] Design reviewed for mobile app performance considerations
- [ ] Migration strategy outlined for implementation phase
- [ ] Documentation includes relationship diagrams and field descriptions