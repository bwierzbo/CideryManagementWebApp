---
name: Core API Implementation
status: open
created: 2025-09-25T21:30:16Z
updated: 2025-09-25T22:04:53Z
github: https://github.com/bwierzbo/CideryManagementWebApp/issues/71
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task: Core API Implementation

## Description
Implement the core tRPC procedure `packaging.createFromCellar` with atomic transaction handling. This procedure orchestrates all side effects of bottling: creating the packaging run, updating vessel volume and status, creating inventory items with lot codes, and logging audit trails.

## Acceptance Criteria
- [ ] `createFromCellar` procedure validates all inputs with Zod
- [ ] Atomic transaction ensures all-or-nothing updates
- [ ] Vessel volume correctly decremented
- [ ] Vessel status changes to "Cleaning" when empty (â‰¤ 0.1L)
- [ ] Inventory items created with unique lot codes
- [ ] Audit logs capture all changes
- [ ] Proper error handling and rollback on failure

## Technical Details
- Create new router: `packages/api/src/routers/packaging.ts`
- Use database transaction wrapper for atomicity
- Lot code format: `BATCHCODE-YYMMDD-P{seq}`
- Validation rules:
  - Cannot overdraw vessel volume
  - Loss must be non-negative
  - Units must be positive integer
- Return structure includes runId for redirect

## Dependencies
- [ ] Task 001: Database schema must be created first
- [ ] Existing inventory and audit systems

## Effort Estimate
- Size: M
- Hours: 8 hours
- Parallel: false (depends on database schema)

## Definition of Done
- [ ] tRPC procedure implemented with full validation
- [ ] Transaction handling tested
- [ ] Unit tests for business logic
- [ ] Integration test for full flow
- [ ] Error cases handled gracefully
- [ ] API types exported for frontend use
