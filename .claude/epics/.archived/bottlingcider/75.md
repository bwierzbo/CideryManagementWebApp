---
name: Validation & Guards
status: open
created: 2025-09-25T21:30:16Z
updated: 2025-09-25T22:04:53Z
github: https://github.com/bwierzbo/CideryManagementWebApp/issues/75
depends_on: [003]
parallel: true
conflicts_with: []
---

# Task: Validation & Guards

## Description
Implement comprehensive validation, overdraw protection, loss warnings, and concurrent bottling locks to ensure data integrity and prevent user errors. This includes both frontend and backend validation.

## Acceptance Criteria
- [ ] Cannot bottle more than vessel's available volume
- [ ] Warning shown when loss > 5%
- [ ] Confirmation required for high loss scenarios
- [ ] Concurrent bottling of same vessel prevented
- [ ] Negative loss values blocked
- [ ] All validations work on frontend and backend
- [ ] Clear error messages for validation failures

## Technical Details
- Frontend validation in BottlingModal with Zod
- Backend validation in createFromCellar procedure
- Implement pessimistic locking on vessel during operation
- Loss warning threshold: 5% of volume taken
- Use database row-level locks for concurrency
- Add confirmDialog for high-loss scenarios
- Server-side recalculation of all values for security

## Dependencies
- [ ] Task 003: API implementation for backend validation
- [ ] Task 002: Modal for frontend validation

## Effort Estimate
- Size: S
- Hours: 4 hours
- Parallel: true (can add to existing code)

## Definition of Done
- [ ] Frontend validation prevents invalid submissions
- [ ] Backend validation double-checks all inputs
- [ ] Concurrent operations properly blocked
- [ ] Loss warnings display correctly
- [ ] Error messages are user-friendly
- [ ] Unit tests for validation logic
